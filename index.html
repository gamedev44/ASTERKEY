<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aster-Key.JS v2.5</title>
    <style>
        :root {
            --primary-bg: #019147;
            --btn-bg: #fff;
            --btn-hover: #f0f0f0;
            --btn-shadow: rgba(0,0,0,0.15);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        video { display: none; }
        canvas {
            flex: 1;
            width: 100%;
            height: 100%;
            display: block;
        }
        .controls {
            position: absolute;
            bottom: 2vh;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            gap: 1vw;
            justify-content: center;
            align-items: center;
            z-index: 10;
            width: 95vw;
        }
        .controls button,
        .controls input[type="color"] {
            padding: 0.8em 1.5em;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            background: var(--btn-bg);
            box-shadow: 0 4px 8px var(--btn-shadow);
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .controls button:hover,
        .controls input[type="color"]:hover {
            background: var(--btn-hover);
            transform: translateY(-2px);
        }
        .controls input[type="range"] {
            width: 120px;
        }
        @media (max-width: 600px) {
            .controls { flex-direction: column; gap: 1vh; }
            .controls button,
            .controls input[type="color"] { width: 80vw; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
    <canvas id="canvasElement"></canvas>
    <div class="controls">
        <button id="toggleMode">Mode: 0</button>
        <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.1" title="Mask Threshold">
        <input type="color" id="bgColor" value="#019147" title="Background Color">
        <button id="uploadLocal">Upload Local Image</button>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <button id="uploadURL">Upload from URL</button>
        <button id="snapshot">Capture</button>
    </div>

    <script>
        const video = document.createElement('video');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');

        let seg, cam;
        let mode = 0;
        let maskThreshold = 0.1;
        let bgColor = '#019147';
        let bgImage = null;

        document.getElementById('toggleMode').addEventListener('click', () => {
            mode = 1 - mode;
            seg.setOptions({ modelSelection: mode });
            document.getElementById('toggleMode').innerText = `Mode: ${mode}`;
        });

        document.getElementById('threshold').addEventListener('input', e => {
            maskThreshold = parseFloat(e.target.value);
        });

        document.getElementById('bgColor').addEventListener('input', e => {
            bgColor = e.target.value;
            bgImage = null;
        });

        document.getElementById('uploadLocal').addEventListener('click', () =>
            document.getElementById('fileInput').click()
        );
        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => bgImage = img;
        });

        document.getElementById('uploadURL').addEventListener('click', () => {
            const url = prompt('Image URL:');
            if (!url) return;
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.src = url;
            img.onload = () => bgImage = img;
        });

        document.getElementById('snapshot').addEventListener('click', () => {
            canvas.toBlob(blob => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `capture_${Date.now()}.png`;
                a.click();
            });
        });

        function onResults(r) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0,0,canvas.width,canvas.height);

            // draw mask
            ctx.drawImage(r.segmentationMask, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'threshold';
            // threshold simulation
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(video, 0,0,canvas.width,canvas.height);
            ctx.globalCompositeOperation = 'destination-over';

            if (bgImage) {
                ctx.drawImage(bgImage, 0,0,canvas.width,canvas.height);
            } else {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0,0,canvas.width,canvas.height);
            }
            ctx.globalCompositeOperation = 'source-over';
        }

        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await video.play();
            } catch(e) {
                alert('Webcam error: ' + e);
            }

            seg = new SelfieSegmentation({
                locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
            });
            seg.setOptions({ modelSelection: mode });
            seg.onResults(onResults);

            cam = new Camera(video, {
                onFrame: async () => await seg.send({ image: video }),
                width: 640, height: 480
            });
            cam.start();
        }

        setup();
    </script>
</body>
</html>
